
/*-------------------------------------------------*/
/*                                                 */
/*   		     DHT11²É¼¯ÎÂÊª¶È                    */
/*                                                 */
/*-------------------------------------------------*/

// Ó²¼þÁ¬½Ó£º
// DATA£ºPA6 

#include "stm32f10x.h"  //°üº¬ÐèÒªµÄÍ·ÎÄ¼þ
#include "dht11.h"      //°üº¬ÐèÒªµÄÍ·ÎÄ¼þ 
#include "delay.h"      //°üº¬ÐèÒªµÄÍ·ÎÄ¼þ
#include "usart1.h"     //°üº¬ÐèÒªµÄÍ·ÎÄ¼þ

/*-------------------------------------------------*/
/*º¯ÊýÃû£º¸´Î»DHT11                                */
/*²Î  Êý£ºÎÞ                                       */
/*·µ»ØÖµ£ºÎÞ                                       */
/*-------------------------------------------------*/  
void DHT11_Rst(void)	   
{                 
  DHT11_IO_OUT(); 	//ÉèÖÃIOÊä³öÄ£Ê½
  DHT11_OUT(0); 	//À­µÍIO
  delay_ms(30);      //À­µÍÖÁÉÙ18ms£¬ÎÒÃÇÀ­µÍ30
  DHT11_OUT(1); 	//À­¸ßIO
  delay_us(30);      //Ö÷»úÀ­¸ß20~40us£¬ÎÒÃÇÀ­¸ß30us
}

/*-------------------------------------------------*/
/*º¯ÊýÃû£ºµÈ´ýDHT11µÄ»ØÓ¦                           */
/*²Î  Êý£ºÎÞ                                       */
/*·µ»ØÖµ£º1´íÎó 0ÕýÈ·                               */
/*-------------------------------------------------*/ 
char DHT11_Check(void) 	   
{   
	char timeout;                            //¶¨ÒåÒ»¸ö±äÁ¿ÓÃÓÚ³¬Ê±ÅÐ¶Ï  
	
	timeout = 0;                             //³¬Ê±±äÁ¿ÇåÁã    
	DHT11_IO_IN();                           //IOÉèÖÃÊäÈëÄ£Ê½
    while((DHT11_DQ_IN == 1) && (timeout < 70))//DHT11»áÀ­µÍ40~50us,ÎÒÃÇµÈ´ý70us³¬Ê±Ê±¼ä	
	{	 
		timeout++;                           //³¬Ê±±äÁ¿+1
		delay_us(1);                       	 //ÑÓÊ±1us
	} 
	if(timeout >= 70)return 1;               //Èç¹ûtimeout>=70,ËµÃ÷ÊÇÒòÎª³¬Ê±ÍË³öµÄwhileÑ­»·£¬·µ»Ø1±íÊ¾´íÎó
	else timeout = 0;                        //·´Ö®£¬ËµÃ÷ÊÇÒòÎªµÈµ½ÁËDHT11À­µÍIO£¬ÍË³öµÄwhileÑ­»·£¬ÕýÈ·²¢ÇåÁãtimeout
    while((DHT11_DQ_IN == 0) && (timeout < 70))//DHT11À­µÍºó»áÔÙ´ÎÀ­¸ß40~50us,,ÎÒÃÇµÈ´ý70us³¬Ê±Ê±¼ä	
	{ 		
		timeout++;                           //³¬Ê±±äÁ¿+1
		delay_us(1);                          //ÑÓÊ±1us
	}
	if(timeout >= 70)return 2;               //Èç¹ûtimeout>=70,ËµÃ÷ÊÇÒòÎª³¬Ê±ÍË³öµÄwhileÑ­»·£¬·µ»Ø2±íÊ¾´íÎó  
	return 0;                                //·´Ö®ÕýÈ·£¬·µ»Ø0
}
/*-------------------------------------------------*/
/*º¯ÊýÃû£º¶ÁÈ¡Ò»¸öÎ»                                */
/*²Î  Êý£ºÎÞ                                       */
/*·µ»ØÖµ£º1»ò0                                     */
/*-------------------------------------------------*/ 
char DHT11_Read_Bit(void) 			 
{
 	char timeout;                          	   //¶¨ÒåÒ»¸ö±äÁ¿ÓÃÓÚ³¬Ê±ÅÐ¶Ï  
	
	timeout = 0;                               //ÇåÁãtimeout	
	while((DHT11_DQ_IN == 1) && (timeout < 40))//Ã¿Ò»Î»Êý¾Ý¿ªÊ¼£¬ÊÇ12~14usµÄµÍµçÆ½£¬ÎÒÃÇµÈ40us
	{   
		timeout++;                             //³¬Ê±±äÁ¿+1
		delay_us(1);                            //ÑÓÊ±1us
	}
	timeout = 0;                               //ÇåÁãtimeout	
	while((DHT11_DQ_IN == 0) && (timeout < 60))//½ÓÏÂÀ´£¬DHT11»áÀ­¸ßIO£¬¸ù¾ÝÀ­¸ßµÄÊ±¼äÅÐ¶ÏÊÇ0»ò1£¬ÎÒÃÇµÈ60us
	{  
		timeout++;                             //³¬Ê±±äÁ¿+1
		delay_us(1);                            //ÑÓÊ±1us
	}
	delay_us(35);                               //ÑÓÊ±35us
	if(DHT11_DQ_IN)return 1;                   //Èç¹ûÑÓÊ±ºó£¬ÊÇ¸ßµçÆ½£¬ÄÇÃ´±¾Î»½ÓÊÕµÄÊÇ1£¬·µ»Ø1
	else return 0;		                       //·´Ö®ÑÓÊ±ºó£¬ÊÇµÍµçÆ½£¬ÄÇÃ´±¾Î»½ÓÊÕµÄÊÇ0£¬·µ»Ø0
}

/*-------------------------------------------------*/
/*º¯ÊýÃû£º¶ÁÈ¡Ò»¸ö×Ö½Ú                              */
/*²Î  Êý£ºÎÞ                                       */
/*·µ»ØÖµ£ºÊý¾Ý                                      */
/*-------------------------------------------------*/ 
char DHT11_Read_Byte(void)    
{        
    char i;                       				//¶¨ÒåÒ»¸ö±äÁ¿ÓÃÓÚforÑ­»·  
	char dat;                              		//¶¨ÒåÒ»¸ö±äÁ¿ÓÃÓÚ±£´æÊý¾Ý 
	dat = 0;	                        		//Çå³ý±£´æÊý¾ÝµÄ±äÁ¿
	for (i = 0; i < 8; i++){              		//Ò»¸ö×Ö½Ú8Î»£¬Ñ­»·8´Î	
   		dat <<= 1;                    			//×óÒÆÒ»Î»£¬ÌÚ³ö¿ÕÎ»    
	    dat |= DHT11_Read_Bit();      			//¶ÁÈ¡Ò»Î»Êý¾Ý
    }						    
    return dat;                   				//·µ»ØÒ»¸ö×Ö½ÚµÄÊý¾Ý
}

/*-------------------------------------------------*/
/*º¯ÊýÃû£º¶ÁÈ¡Ò»´ÎÊý¾ÝÎÂÊª¶È                         */
/*²Î  Êý£ºtemp:ÎÂ¶ÈÖµ                               */
/*²Î  Êý£ºhumi:Êª¶ÈÖµ                               */
/*·µ»ØÖµ£º1´íÎó 0ÕýÈ·                               */
/*-------------------------------------------------*/ 
char DHT11_Read_Data(char *temp, char *humi)    
{        
 	char buf[5];                                         //Ò»´ÎÍêÕûµÄÊý¾ÝÓÐ5¸ö×Ö½Ú£¬¶¨ÒåÒ»¸ö»º³åÇø
	
	char i;                                              //¶¨ÒåÒ»¸ö±äÁ¿ÓÃÓÚforÑ­»·  
	DHT11_Rst();                                         //¸´Î»DHT11	
	if(DHT11_Check() == 0)							     //ÅÐ¶ÏDHT11»Ø¸´×´Ì¬=0µÄ»°£¬±íÊ¾ÕýÈ·£¬½øÈëif
	{
		for(i = 0; i < 5; i++){                          //Ò»´ÎÍêÕûµÄÊý¾ÝÓÐ5¸ö×Ö½Ú£¬Ñ­»·5´Î		
			buf[i] = DHT11_Read_Byte();                  //Ã¿´Î¶ÁÈ¡Ò»¸ö×Ö½Ú
		}
		if((buf[0] + buf[1] + buf[2] + buf[3]) == buf[4])//ÅÐ¶ÏÊý¾ÝÐ£Ñé£¬Ç°4¸ö×Ö½ÚÏà¼ÓÓ¦¸ÃµÈÓÚµÚ5¸ö×Ö½Ú£¬ÕýÈ·µÄ»°£¬½øÈëif	
		{     
			u1_printf("%d\r\n",buf[0]); 	//ÎÂ¶ÈÊý¾Ý
			u1_printf("%d\r\n",buf[1]);
			u1_printf("%d\r\n",buf[2]);	//Êª¶ÈÊý¾Ý
			u1_printf("%d\r\n",buf[3]);
			u1_printf("%d\r\n",buf[4]);
			*humi = buf[0];                              //Êª¶ÈÊý¾Ý£¬±£´æÔÚhumiÖ¸ÕëÖ¸ÏòµÄµØÖ·±äÁ¿ÖÐ
			*temp = buf[2];							     //ÎÂ¶ÈÊý¾Ý£¬±£´æÔÚtempÖ¸ÕëÖ¸ÏòµÄµØÖ·±äÁ¿ÖÐ
		}else return 1;                                  //·´Ö®£¬Êý¾ÝÐ£Ñé´íÎó£¬Ö±½Ó·µ»Ø1
	}else return 2;                                      //·´Ö®£¬Èç¹ûDHT11»Ø¸´×´Ì¬=1µÄ»°£¬±íÊ¾´íÎó£¬½øÈëelse£¬Ö±½Ó·µ»Ø2
	
	return 0;	                                         //¶ÁÈ¡ÕýÈ··µ»Ø0    
}  

/*-------------------------------------------------*/
/*º¯ÊýÃû£º³õÊ¼»¯DHT11                              */
/*²Î  Êý£ºÎÞ                                       */
/*·µ»ØÖµ£º1´íÎó 0ÕýÈ·                              */
/*-------------------------------------------------*/    	 
char DHT11_Init(void)
{
	GPIO_InitTypeDef GPIO_InitStructure;                  //¶¨ÒåÒ»¸öIO¶Ë¿Ú²ÎÊý½á¹¹Ìå
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE); //Ê¹ÄÜPA¶Ë¿ÚÊ±ÖÓ
	
	GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_6;            //×¼±¸ÉèÖÃPA8
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;     //ËÙÂÊ50Mhz
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;   	  //ÍÆÃâÊä³ö·½Ê½
	GPIO_Init(GPIOA, &GPIO_InitStructure);            	  //ÉèÖÃPA8	
	DHT11_Rst();                                          //¸´Î»DHT11
	return DHT11_Check();                                 //·µ»ØDHT11µÄ»Ø¸´×´Ì¬
}





